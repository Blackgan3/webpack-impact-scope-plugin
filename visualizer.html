<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Changed Modules 层级可视化</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #fff;
      padding: 16px 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .actions {
      display: flex;
      gap: 12px;
    }
    button {
      border: 1px solid #dcdfe6;
      background: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      border-color: #409eff;
      color: #409eff;
    }
    main {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .tree {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }
    .node {
      margin-left: 20px;
      position: relative;
    }
    .node::before {
      content: '';
      position: absolute;
      left: -12px;
      top: 12px;
      width: 8px;
      height: 1px;
      background: #c0c4cc;
    }
    .node.has-parent::after {
      content: '';
      position: absolute;
      left: -12px;
      top: -8px;
      bottom: 12px;
      width: 1px;
      background: #c0c4cc;
    }
    .card {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f0f8ff;
      border: 1px solid #b3d8ff;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: background .2s;
    }
    .card:hover {
      background: #e6f2ff;
    }
    .card .icon {
      width: 14px;
      height: 14px;
      fill: #409eff;
    }
    .card .label {
      max-width: none;
      overflow: visible;
      white-space: normal;
      word-break: break-all;
    }
    .children {
      margin-top: 8px;
      display: none;
    }
    .children.open {
      display: block;
    }
    .empty {
      text-align: center;
      padding: 48px 0;
      color: #909399;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Changed Modules 层级可视化</h1>
    <div class="actions">
      <button id="expandAll">展开全部</button>
      <button id="collapseAll">收起全部</button>
      <button id="refresh">刷新数据</button>
    </div>
  </header>
  <main>
    <div id="tree" class="tree"></div>
  </main>

  <script>
    const treeEl = document.getElementById('tree');
    const expandBtn = document.getElementById('expandAll');
    const collapseBtn = document.getElementById('collapseAll');
    const refreshBtn = document.getElementById('refresh');

    let data = [];

    function loadData() {
      fetch('./changed-modules.json')
        .then(res => res.text())
        .then(text => {
          // 简单修复非标准 JSON（单引号）
          const jsonText = text.replace(/(\w+):/g, '"$1":').replace(/'/g, '"');
          data = JSON.parse(jsonText);
          render();
        })
        .catch(() => {
          treeEl.innerHTML = '<div class="empty">加载 changed-modules.json 失败，请先运行构建。</div>';
        });
    }

    function renderNode(node, container, depth = 0) {
      const nodeEl = document.createElement('div');
      nodeEl.className = 'node' + (depth ? ' has-parent' : '');

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <svg class="icon" viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>
        <span class="label" title="${node.id}">${node.id}</span>
      `;
      nodeEl.appendChild(card);

      const childrenEl = document.createElement('div');
      childrenEl.className = 'children';
      if (node.parent && node.parent.length) {
        node.parent.forEach(p => renderNode(p, childrenEl, depth + 1));
        nodeEl.appendChild(childrenEl);

        card.addEventListener('click', () => {
          childrenEl.classList.toggle('open');
          const icon = card.querySelector('.icon path');
          icon.setAttribute('d', childrenEl.classList.contains('open')
            ? 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'
            : 'M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z');
        });
      }

      container.appendChild(nodeEl);
    }

    function render() {
      treeEl.innerHTML = '';
      if (!data.length) {
        treeEl.innerHTML = '<div class="empty">暂无数据</div>';
        return;
      }
      data.forEach(node => renderNode(node, treeEl));
    }

    expandBtn.addEventListener('click', () => {
      document.querySelectorAll('.children').forEach(el => el.classList.add('open'));
    });

    collapseBtn.addEventListener('click', () => {
      document.querySelectorAll('.children').forEach(el => el.classList.remove('open'));
    });

    refreshBtn.addEventListener('click', loadData);

    loadData();
  </script>
</body>
</html>